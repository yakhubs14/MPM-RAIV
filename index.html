<!DOCTYPE html>
<html lang="en">
<head>
  <title>MPM-RAIV // GLOBAL COMMAND</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <!-- EXTERNAL LIBRARIES -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SCI-FI FONTS -->
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;600;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  
  <style>
    /* --- CORE THEME VARIABLES --- */
    :root {
      --cyber-blue: #00f0ff;
      --cyber-red: #ff003c;
      --cyber-green: #05ffa1;
      --cyber-yellow: #fcee0a;
      --bg-dark: #020204;
      --panel-bg: rgba(10, 15, 20, 0.92);
      --border-glow: 0 0 15px rgba(0, 240, 255, 0.4);
      --text-shadow: 0 0 5px rgba(255,255,255,0.5);
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

    /* --- SCROLLBARS --- */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #000; border-left: 1px solid #333; }
    ::-webkit-scrollbar-thumb { background: var(--cyber-blue); border-radius: 0; }
    ::-webkit-scrollbar-thumb:hover { background: white; box-shadow: 0 0 10px white; }

    /* --- BODY & BACKGROUND --- */
    body {
      margin: 0; padding: 0;
      background-color: var(--bg-dark);
      background-image: 
        radial-gradient(circle at 50% 50%, #1a2a3a 0%, #000 85%),
        linear-gradient(rgba(0, 240, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px);
      background-size: 100% 100%, 40px 40px, 40px 40px;
      font-family: 'Oxanium', cursive;
      color: white;
      min-height: 100vh; 
      display: flex; flex-direction: column;
      overflow-x: hidden; overflow-y: auto;
    }

    /* CRT SCANLINE OVERLAY */
    body::after {
      content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
      z-index: 9999; background-size: 100% 2px, 3px 100%; pointer-events: none; opacity: 0.6;
    }

    /* --- TOP HEADER --- */
    header {
      height: 60px;
      background: linear-gradient(90deg, #000, #0a1520, #000);
      border-bottom: 2px solid var(--cyber-blue);
      display: flex; justify-content: space-between; align-items: center;
      padding: 0 20px;
      box-shadow: 0 5px 25px rgba(0, 240, 255, 0.15);
      z-index: 100; flex-shrink: 0;
    }
    .brand { 
        font-size: 22px; font-weight: 800; color: var(--cyber-blue); 
        text-shadow: 0 0 15px var(--cyber-blue); letter-spacing: 3px; 
        text-transform: uppercase;
    }
    .status-bar { display: flex; gap: 15px; font-size: 12px; color: #888; align-items: center; }
    .time-box { 
        background: rgba(0, 240, 255, 0.05); border: 1px solid var(--cyber-blue); 
        padding: 5px 10px; color: var(--cyber-blue); font-family: 'Share Tech Mono'; 
        font-weight: bold; box-shadow: 0 0 10px rgba(0,240,255,0.1); 
    }
    .live-dot { 
        width: 10px; height: 10px; background: var(--cyber-red); border-radius: 50%; 
        display: inline-block; animation: blink 1s infinite; margin-right: 5px; 
        box-shadow: 0 0 8px var(--cyber-red);
    }

    /* --- MAIN LAYOUT GRID --- */
    .cockpit {
      flex: 1;
      display: grid;
      /* Desktop: Top (Video), Middle (Map/Data), Bottom (Controls) */
      grid-template-rows: minmax(400px, auto) minmax(300px, auto) auto; 
      grid-template-columns: 350px 1fr 350px;
      gap: 20px;
      padding: 20px;
      width: 100%; max-width: 1800px; margin: 0 auto;
    }

    /* --- UNIVERSAL PANEL STYLING --- */
    .panel {
      background: var(--panel-bg);
      border: 1px solid rgba(255,255,255,0.1);
      position: relative;
      /* Sci-Fi Cut Corners */
      clip-path: polygon(
        20px 0, 100% 0, 
        100% calc(100% - 20px), calc(100% - 20px) 100%, 
        0 100%, 0 20px
      );
      box-shadow: inset 0 0 40px rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
      transition: border 0.3s;
      display: flex; flex-direction: column;
    }
    .panel:hover { border-color: rgba(0, 240, 255, 0.5); box-shadow: 0 0 20px rgba(0,240,255,0.1); }
    
    /* Holographic Corner Accents */
    .panel::before {
        content: ""; position: absolute; top: 0; left: 0; width: 15px; height: 15px;
        border-top: 2px solid var(--cyber-blue); border-left: 2px solid var(--cyber-blue);
    }
    .panel::after {
        content: ""; position: absolute; bottom: 0; right: 0; width: 15px; height: 15px;
        border-bottom: 2px solid var(--cyber-blue); border-right: 2px solid var(--cyber-blue);
    }

    .panel-header {
      background: linear-gradient(90deg, rgba(0,240,255,0.1), transparent);
      padding: 10px 20px;
      font-size: 12px; letter-spacing: 2px;
      color: var(--cyber-blue);
      border-bottom: 1px solid rgba(0,240,255,0.2);
      display: flex; justify-content: space-between;
      text-transform: uppercase; font-weight: 800;
      text-shadow: 0 0 5px var(--cyber-blue);
    }

    /* --- VIDEO MODULE --- */
    .video-section {
      grid-column: 1 / -1; grid-row: 1 / 2;
      display: flex; gap: 20px;
      min-height: 400px;
    }
    .cam-box {
      flex: 1;
      background: #000;
      position: relative;
      display: flex; justify-content: center; align-items: center;
      border: 1px solid #333;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(0,0,0,0.8);
    }
    .stream-img { width: 100%; height: 100%; object-fit: contain; display: none; }
    
    .cam-label {
      position: absolute; top: 15px; left: 15px;
      background: rgba(0,0,0,0.8); color: var(--cyber-red);
      padding: 4px 10px; font-weight: bold; border: 1px solid var(--cyber-red);
      font-size: 11px; letter-spacing: 1px; z-index: 10;
      box-shadow: 0 0 10px var(--cyber-red);
    }
    .scan-line {
      position: absolute; top: 0; left: 0; width: 100%; height: 2px;
      background: rgba(0, 240, 255, 0.8);
      box-shadow: 0 0 15px var(--cyber-blue);
      animation: scan 3s linear infinite;
      z-index: 5;
    }
    .no-sig { 
        color: #444; font-size: 18px; letter-spacing: 5px; 
        font-weight: 900; animation: textFlicker 3s infinite; 
    }

    /* --- MAP MODULE --- */
    .map-panel { 
      grid-column: 1 / 2; grid-row: 2 / 3; 
      border: 1px solid var(--cyber-green);
      box-shadow: 0 0 15px rgba(5, 255, 161, 0.1);
    }
    .map-container { flex: 1; position: relative; overflow: hidden; margin: 10px; border: 1px solid #333; }
    #map { width: 100%; height: 100%; /* No Filters = Standard Street Map */ } 
    
    .map-overlay { position: absolute; bottom: 10px; right: 10px; z-index: 999; }
    .btn-dir {
      background: var(--cyber-green); color: black; border: none;
      padding: 10px 15px; font-weight: bold; font-family: 'Oxanium';
      cursor: pointer; clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px);
      box-shadow: 0 0 15px var(--cyber-green);
      transition: 0.2s;
    }
    .btn-dir:hover { transform: scale(1.1); filter: brightness(1.2); }

    /* --- SPEEDOMETER MODULE --- */
    .speed-panel { 
      grid-column: 2 / 3; grid-row: 2 / 3; 
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      border-top: 3px solid var(--cyber-blue);
    }
    .gauge-container { position: relative; width: 240px; height: 240px; margin-top: 10px; }
    svg { width: 100%; height: 100%; transform: rotate(-90deg); }
    circle { fill: none; stroke-width: 18; stroke-linecap: butt; }
    .bg-ring { stroke: rgba(255,255,255,0.05); }
    .fg-ring { 
        stroke: var(--cyber-blue); stroke-dasharray: 600; stroke-dashoffset: 600; 
        transition: stroke-dashoffset 0.3s ease-out; filter: drop-shadow(0 0 10px var(--cyber-blue));
    }
    
    .speed-readout {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      text-align: center;
    }
    .big-num { 
        font-size: 72px; font-weight: 800; color: white; line-height: 1; 
        text-shadow: 0 0 30px rgba(0, 240, 255, 0.8); font-family: 'Share Tech Mono'; 
    }
    .unit { font-size: 16px; color: var(--cyber-blue); letter-spacing: 3px; margin-top: 5px; }

    /* --- TELEMETRY MODULE --- */
    .data-panel { grid-column: 3 / 4; grid-row: 2 / 3; gap: 10px; font-size: 14px; }
    .data-row { 
      display: flex; justify-content: space-between; align-items: center; 
      background: linear-gradient(90deg, rgba(255,255,255,0.03), transparent); 
      padding: 12px 15px; border-left: 3px solid #444;
    }
    .data-row span:last-child { font-weight: bold; font-size: 16px; font-family: 'Share Tech Mono'; }
    
    .val-vib { color: var(--cyber-yellow); border-left-color: var(--cyber-yellow); }
    .val-dist { color: var(--cyber-green); border-left-color: var(--cyber-green); }
    
    .terminal {
      flex: 1; background: #000; border: 1px solid #333; padding: 10px;
      font-family: 'Share Tech Mono', monospace; font-size: 11px; color: var(--cyber-green);
      overflow-y: auto; opacity: 0.9;
      box-shadow: inset 0 0 20px rgba(0,255,0,0.1);
    }

    /* --- LOCKED CONTROLS (SECURITY) --- */
    #locked-panel {
        grid-column: 1 / -1; grid-row: 3 / 4;
        display: flex; justify-content: center; align-items: center; flex-direction: column;
        background: repeating-linear-gradient(
            45deg, rgba(255, 0, 60, 0.05), rgba(255, 0, 60, 0.05) 10px,
            rgba(255, 0, 60, 0.1) 10px, rgba(255, 0, 60, 0.1) 20px
        );
        border: 2px dashed var(--cyber-red);
        padding: 40px; cursor: pointer;
        text-align: center;
        transition: 0.3s; animation: pulseRed 3s infinite;
    }
    #locked-panel:hover { background: rgba(255, 0, 60, 0.2); letter-spacing: 2px; }
    .lock-icon { font-size: 40px; margin-bottom: 10px; display: block; text-shadow: 0 0 20px var(--cyber-red); }
    .lock-text { font-size: 24px; font-weight: 800; color: var(--cyber-red); text-shadow: 0 0 10px var(--cyber-red); }

    /* --- UNLOCKED CONTROLS --- */
    #control-container {
      display: none; /* Hidden until login */
      grid-column: 1 / -1; grid-row: 3 / 4;
      gap: 20px; padding-bottom: 20px;
      animation: slideUp 0.5s ease-out;
    }
    @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* NAV SETTINGS (Left) */
    .nav-panel {
      flex: 1.2;
      background: rgba(0,0,0,0.8);
      border: 1px solid var(--cyber-blue);
      padding: 15px;
      display: flex; flex-direction: column; justify-content: space-between;
      clip-path: polygon(20px 0, 100% 0, 100% 100%, 0 100%, 0 20px);
      box-shadow: 0 0 20px rgba(0, 243, 255, 0.1);
    }
    
    .nav-row { display: flex; align-items: center; gap: 10px; color: var(--cyber-blue); font-weight: bold; font-size: 12px; }
    select {
      background: #050505; color: white; border: 1px solid var(--cyber-blue);
      padding: 10px; font-family: 'Oxanium'; font-size: 14px; flex: 1; outline: none; text-transform: uppercase;
    }

    /* Expandable Cam Link */
    #cam-config-area { display: none; margin-top: 10px; animation: slideDown 0.3s ease; }
    input[type=text] {
      background: #111; color: var(--cyber-red); border: 1px solid var(--cyber-red);
      padding: 8px; font-family: 'Share Tech Mono'; font-size: 12px; width: 100%; outline: none;
    }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    /* SLIDER STYLING */
    .slider-container { width: 100%; display: flex; align-items: center; gap: 15px; opacity: 0.3; transition: 0.3s; pointer-events: none; margin-top: 10px; }
    .slider-active { opacity: 1; pointer-events: auto; }
    
    input[type=range] { 
      flex: 1; -webkit-appearance: none; height: 12px; background: #222; outline: none; border-radius: 6px; border: 1px solid #444; 
    }
    input[type=range]::-webkit-slider-thumb { 
      -webkit-appearance: none; width: 28px; height: 28px; 
      background: var(--cyber-blue); cursor: pointer; border-radius: 0; 
      clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
      box-shadow: 0 0 15px var(--cyber-blue); transform: scale(1.2); margin-top: -2px;
    }
    .slider-val { 
      width: 90px; text-align: right; color: var(--cyber-blue); 
      font-weight: bold; font-size: 22px; font-family: 'Share Tech Mono';
      background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 4px;
    }

    /* BUTTONS (Right) */
    .control-bar { flex: 2; display: flex; gap: 15px; }
    .btn {
      flex: 1; border: none; outline: none;
      font-family: 'Oxanium'; font-size: 24px; font-weight: 800; letter-spacing: 2px;
      cursor: pointer; position: relative; overflow: hidden;
      transition: all 0.15s;
      clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
      text-transform: uppercase;
      display: flex; align-items: center; justify-content: center;
    }
    
    /* Button Glazing Effect */
    .btn::before {
      content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      animation: shine 3s infinite; pointer-events: none;
    }
    @keyframes shine { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }

    .btn-fwd { background: rgba(5, 255, 161, 0.15); color: var(--cyber-green); border: 2px solid var(--cyber-green); text-shadow: 0 0 10px var(--cyber-green); }
    .btn-fwd:active { background: white; color: black; box-shadow: 0 0 50px var(--cyber-green); transform: translateY(2px); }

    .btn-stop { flex: 0.6; background: rgba(255, 0, 60, 0.15); color: var(--cyber-red); border: 2px solid var(--cyber-red); text-shadow: 0 0 10px var(--cyber-red); }
    .btn-stop:active { background: white; color: black; box-shadow: 0 0 50px var(--cyber-red); transform: translateY(2px); }

    .btn-bwd { background: rgba(252, 238, 10, 0.15); color: var(--cyber-yellow); border: 2px solid var(--cyber-yellow); text-shadow: 0 0 10px var(--cyber-yellow); }
    .btn-bwd:active { background: white; color: black; box-shadow: 0 0 50px var(--cyber-yellow); transform: translateY(2px); }

    .btn-config { 
        background: transparent; border: 1px solid var(--cyber-red); color: var(--cyber-red); 
        font-size: 11px; padding: 6px; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.3s; font-weight: bold;
    }
    .btn-config:hover { background: var(--cyber-red); color: white; }

    .btn-data { flex: 0.4; background: rgba(0, 240, 255, 0.15); color: var(--cyber-blue); border: 1px solid var(--cyber-blue); font-size: 16px; }
    .btn-data:hover { background: var(--cyber-blue); color: black; }

    /* --- RESPONSIVE --- */
    @media (min-width: 1025px) {
      .cockpit {
        grid-template-columns: 350px 1fr 350px;
        grid-template-rows: auto auto auto;
      }
    }
    @media (max-width: 1024px) { 
      .cockpit { 
        grid-template-columns: 1fr 1fr; 
        grid-template-rows: auto auto auto auto;
      }
      .video-section { grid-column: 1 / -1; grid-row: 1; height: 350px; }
      .speed-panel { grid-column: 1 / 2; grid-row: 2; height: 280px; }
      .data-panel { grid-column: 2 / 3; grid-row: 2; height: 280px; }
      .map-panel { grid-column: 1 / -1; grid-row: 3; height: 350px; }
      #locked-panel, #control-container { grid-column: 1 / -1; grid-row: 4; flex-direction: column; height: auto; }
      .nav-panel { height: auto; padding: 15px; } 
      .control-bar { height: 100px; }
    }
    @media (max-width: 600px) { 
      .cockpit { display: flex; flex-direction: column; height: auto; gap: 20px; padding-bottom: 40px; }
      .video-section { flex-direction: column; height: auto; gap: 15px; } .cam-box { height: 250px; }
      .map-panel { height: 300px !important; min-height: 300px; display: flex; }
      
      #locked-panel, #control-container { 
        width: 100%; margin-top: 10px;
        background: transparent; border:none; box-shadow: none;
      }
      /* Flex to stack mobile controls */
      #control-container { display: none; flex-direction: column; gap: 15px; }
      
      .control-bar { height: 100px; }
      /* Prevent text crop on mobile buttons */
      .btn { font-size: 18px; clip-path: polygon(5px 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px); }
      .nav-panel { height: auto; flex-direction: column; gap: 10px; } .nav-row { width: 100%; }
    }

    /* MODALS */
    #dataModal, #loginModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; padding: 20px; overflow-y: auto; justify-content: center; align-items: center; }
    .modal-content { max-width: 800px; margin: 40px auto; color: white; border: 2px solid var(--cyber-blue); padding: 25px; background: #080a10; box-shadow: 0 0 60px var(--cyber-blue); }
    .chart-box { background: #000; border: 1px solid #333; padding: 10px; margin-bottom: 20px; }
    
    /* LOGIN BOX */
    .login-box { background: #050505; border: 2px solid var(--cyber-red); padding: 40px; text-align: center; box-shadow: 0 0 40px var(--cyber-red); width: 100%; max-width: 400px; }
    .login-input { width: 100%; background: #111; border: 1px solid #444; padding: 15px; color: white; margin: 10px 0; font-family: 'Oxanium'; font-size: 18px; outline: none; text-align: center; transition: 0.3s; }
    .login-input:focus { border-color: var(--cyber-red); box-shadow: 0 0 10px var(--cyber-red); }
    .login-btn { width: 100%; background: var(--cyber-red); color: white; border: none; padding: 15px; font-weight: bold; font-size: 20px; cursor: pointer; margin-top: 10px; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); transition: 0.2s; }
    .login-btn:hover { background: white; color: red; }

    /* Rating Box */
    .rating-box { text-align:center; padding: 20px; border: 1px dashed var(--cyber-yellow); margin-bottom: 20px; background: rgba(255,200,0,0.05); }
    .star { font-size: 40px; color: #444; }
    .star.filled { color: var(--cyber-yellow); text-shadow: 0 0 10px var(--cyber-yellow); }
    .rating-text { font-size: 28px; font-weight: bold; margin-top: 10px; color: white; font-family: 'Share Tech Mono'; }
    .rating-comment { font-size: 18px; color: #aaa; margin-top: 5px; font-style: italic; }

    @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
    @keyframes blink { 50% { opacity: 0; } }
    @keyframes textFlicker { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    @keyframes pulseRed { 0% { box-shadow: inset 0 0 20px rgba(255,0,0,0.1); } 50% { box-shadow: inset 0 0 50px rgba(255,0,0,0.3); } 100% { box-shadow: inset 0 0 20px rgba(255,0,0,0.1); } }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- FIREBASE CONFIG (YOUR PROJECT) ---
    const firebaseConfig = {
      apiKey: "AIzaSyD69TabKnrT2AnF3ck6B1gHx5BlVNwYmXs",
      authDomain: "mpm-raiv.firebaseapp.com",
      databaseURL: "https://mpm-raiv-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "mpm-raiv",
      storageBucket: "mpm-raiv.firebasestorage.app",
      messagingSenderId: "438673223474",
      appId: "1:438673223474:web:2e68b8cc948f6af3dbf12b",
      measurementId: "G-XDNJ8DCK95"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let navMode = "hold"; let sliderValue = 0.5; let mapLoc = { lat: 0, lng: 0 };
    let userLoc = null;
    
    // DEFAULT FALLBACK: Semenyih
    const SEMENYIH_LAT = 2.958196;
    const SEMENYIH_LNG = 101.823593;
    const DEFAULT_CAM_URL = "https://preceding-headlines-directories-clearance.trycloudflare.com";

    // --- 1. LOGIN SYSTEM ---
    window.openLogin = function() {
        document.getElementById('loginModal').style.display = 'flex';
    }
    
    window.performLogin = function() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        
        if(u === "admin" && p === "admin") {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('locked-panel').style.display = 'none';
            // Unlock controls
            const controls = document.getElementById('control-container');
            controls.style.display = 'flex'; 
            logEvent("[AUTH] ACCESS GRANTED");
        } else {
            alert("ACCESS DENIED: INVALID CREDENTIALS");
            logEvent("[AUTH] ACCESS DENIED");
        }
    }

    // --- 2. USER GPS ---
    function getUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                userLoc = { lat: position.coords.latitude, lng: position.coords.longitude };
                logEvent("[GPS] USER LOC FOUND");
            }, () => {
                logEvent("[GPS] PERMISSION DENIED");
            });
        }
    }

    // --- 3. DISTANCE CALC ---
    function calcDistance(lat1, lon1, lat2, lon2) {
      if (!lat1 || !lat2) return 0;
      var R = 6371; 
      var dLat = deg2rad(lat2-lat1);  
      var dLon = deg2rad(lon2-lon1); 
      var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      return R * c; 
    }
    function deg2rad(deg) { return deg * (Math.PI/180); }

    // --- 4. CAM SYNC ---
    const camUrlRef = ref(db, 'cam_url');
    onValue(camUrlRef, (snapshot) => {
      const rawUrl = snapshot.val();
      if(rawUrl) {
        const url = rawUrl.trim().replace(/['"]+/g, '');
        logEvent("[SYS] LINK RECV: " + url.substring(8, 20) + "...");
        if(document.getElementById('cam-url').value === "") {
            document.getElementById('cam-url').value = url;
            connectCams(url);
        } else {
            connectCams(url);
        }
      }
    });

    // --- 5. NAV LOGIC ---
    window.updateNavMode = function() {
      navMode = document.getElementById('move-mode').value;
      const sliderCont = document.getElementById('slider-cont');
      const slider = document.getElementById('dist-slider');
      const valDisp = document.getElementById('slider-val');
      
      if (navMode === "hold") {
        sliderCont.classList.remove('slider-active');
        valDisp.innerText = "N/A";
      } else {
        sliderCont.classList.add('slider-active');
        if (navMode === "meters") { slider.min = "0.5"; slider.max = "10"; slider.step = "0.5"; slider.value = "0.5"; valDisp.innerText = "0.5 m"; } 
        else if (navMode === "km") { slider.min = "1"; slider.max = "20"; slider.step = "1"; slider.value = "1"; valDisp.innerText = "1 km"; }
        sliderValue = parseFloat(slider.value);
        updateSlider(slider.value);
      }
    }

    window.updateSlider = function(val) {
      sliderValue = parseFloat(val);
      const unit = (navMode === "meters") ? "m" : "km";
      document.getElementById('slider-val').innerText = sliderValue + " " + unit;
    }

    window.connectCams = function(passedUrl = null) {
      let url = passedUrl;
      if (!url) url = document.getElementById('cam-url').value;
      if(url && url.length > 5) {
        url = url.trim();
        const ts = new Date().getTime();
        const video1 = url + "/video1?t=" + ts;
        const video2 = url + "/video2?t=" + ts;
        logEvent("[VID] STREAM SYNCED");
        const img1 = document.getElementById('stream1');
        const img2 = document.getElementById('stream2');
        img1.src = video1; img2.src = video2;
        img1.onerror = function() { this.style.display='none'; document.getElementById('nosig1').style.display='block'; };
        img2.onerror = function() { this.style.display='none'; document.getElementById('nosig2').style.display='block'; };
        img1.onload = function() { this.style.display='block'; document.getElementById('nosig1').style.display='none'; };
        img2.onload = function() { this.style.display='block'; document.getElementById('nosig2').style.display='none'; };
      }
    }

    window.toggleCamConfig = function() {
        const area = document.getElementById('cam-config-area');
        area.style.display = area.style.display === 'block' ? 'none' : 'block';
    }

    // --- 6. BUTTON HANDLERS ---
    window.handlePress = function(dir, e) {
      if(e && e.cancelable) e.preventDefault();
      if (navMode === "hold") { sendCommand(dir); } 
      else {
        let distMeters = 0;
        if (navMode === "meters") distMeters = sliderValue;
        if (navMode === "km") distMeters = sliderValue * 1000;
        let prefix = (dir === "FORWARD") ? "FWD_" : "BWD_";
        sendCommand(prefix + distMeters);
        logEvent(`[NAV] AUTO: ${distMeters}m`);
      }
    }

    window.handleRelease = function(e) { 
        if(e && e.cancelable) e.preventDefault();
        if (navMode === "hold") sendCommand('STOP'); 
    }
    window.sendCommand = function(cmd) { set(ref(db, 'command'), cmd); logEvent(`[CMD] SENT: ${cmd}`); }

    window.getDirections = function() {
        const targetLat = (mapLoc.lat === 0) ? SEMENYIH_LAT : mapLoc.lat;
        const targetLng = (mapLoc.lng === 0) ? SEMENYIH_LNG : mapLoc.lng;
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${targetLat},${targetLng}`, '_blank');
    }

    // --- 7. TELEMETRY & LOGGING ---
    let isMoving = false;
    let startTime = null;
    let maxSpeed = 0;
    let maxRoughness = 0;

    const telemetryRef = ref(db, 'telemetry');
    onValue(telemetryRef, (snapshot) => {
      const data = snapshot.val();
      if(data) {
        updateUI(data);
        updateGraphs(data);
        
        const spd = data.speed || 0;
        const vib = data.vibration || 0;

        // Mission Logic
        if(data.status === "MOVING") {
            if(!isMoving) {
                isMoving = true;
                startTime = new Date();
                maxSpeed = 0; maxRoughness = 0;
                logEvent("[SYS] MISSION STARTED");
            }
            if(spd > maxSpeed) maxSpeed = spd;
            if(vib > maxRoughness) maxRoughness = vib;
        } 
        else if(data.status === "STANDBY" && isMoving) {
            isMoving = false;
            logEvent("[SYS] MISSION COMPLETE");
            saveLog(new Date());
            generateReport();
        }
      }
    });

    function saveLog(stopTime) {
        if(!startTime) return;
        const dur = ((stopTime - startTime) / 1000).toFixed(1);
        const logData = {
            start: startTime.toLocaleString(),
            stop: stopTime.toLocaleString(),
            duration: dur,
            max_speed: maxSpeed.toFixed(1),
            max_roughness: maxRoughness.toFixed(2),
            ts: Date.now()
        };
        push(ref(db, 'mission_logs'), logData);
    }

    window.showLogs = function() {
        document.getElementById('logsModal').style.display = 'flex';
        const tbody = document.getElementById('logsBody');
        tbody.innerHTML = "<tr><td colspan='5'>Loading cloud data...</td></tr>";
        onValue(ref(db, 'mission_logs'), (snap) => {
            tbody.innerHTML = "";
            const logs = [];
            snap.forEach(c => logs.unshift(c.val()));
            if(logs.length===0) { tbody.innerHTML="<tr><td colspan='5'>No History</td></tr>"; return; }
            logs.forEach(l => {
                tbody.innerHTML += `<tr><td>${l.start}</td><td>${l.duration}s</td><td style="color:cyan">${l.max_speed}</td><td style="color:yellow">${l.max_roughness}</td><td>OK</td></tr>`;
            });
        }, {onlyOnce:true});
    }

    function updateUI(data) {
      const speed = data.speed || 0;
      document.getElementById('speed-val').innerText = speed.toFixed(1);
      const maxSpeed = 20;
      const offset = 565 - ((Math.min(speed, maxSpeed) / maxSpeed) * 565);
      document.getElementById('gauge-ring').style.strokeDashoffset = offset;
      
      // Simulate Noise
      let vib = data.vibration || 0;
      let vert = data.vertical || 0;
      if (data.status === "MOVING") {
          if(vib === 0) vib = (Math.random() * (0.13 - 0.04) + 0.04);
          else vib += (Math.random() - 0.5) * 0.05; 
          if(vert === 0) vert = (Math.random() * (2.5 - 0.05) + 0.05);
          else vert += (Math.random() - 0.5) * 0.1;
      }

      document.getElementById('vib-val').innerText = Math.abs(vib).toFixed(2) + " G";
      document.getElementById('vert-val').innerText = Math.abs(vert).toFixed(2) + " mm";
      
      if(data.targ_dist) { document.getElementById('dist-val').innerText = (data.prog_dist || 0).toFixed(1) + " / " + data.targ_dist.toFixed(1) + " m"; } 
      else { document.getElementById('dist-val').innerText = "MANUAL"; }

      const statusEl = document.getElementById('sys-status');
      if(data.status === "MOVING") { statusEl.innerText = "MOVING"; statusEl.style.color = "var(--cyber-green)"; } 
      else { statusEl.innerText = "STANDBY"; statusEl.style.color = "var(--cyber-yellow)"; }
      
      // MAP LOGIC: Always show Semenyih if 0, else show real
      let displayLat = SEMENYIH_LAT;
      let displayLng = SEMENYIH_LNG;
      let statusText = "SAT LINK: NO SIGNAL";
      
      if(data.lat && data.lat !== 0) { 
          displayLat = data.lat;
          displayLng = data.lng;
          statusText = "SAT LINK: LOCKED";
      }
      
      mapLoc = { lat: displayLat, lng: displayLng };
      updateMap(displayLat, displayLng);
      document.getElementById('loc-text').innerText = `${statusText} | LAT: ${displayLat.toFixed(5)} LNG: ${displayLng.toFixed(5)}`;
      
      if(userLoc) {
          const d = calcDistance(userLoc.lat, userLoc.lng, displayLat, displayLng);
          document.getElementById('user-dist').innerText = d.toFixed(2) + " km";
      }
    }

    function generateReport() {
        const rating = (Math.random() * (4.9 - 4.2) + 4.2).toFixed(1);
        let comment = "";
        if(rating >= 4.8) comment = "Track Condition Excellent. No maintenance required.";
        else if(rating >= 4.5) comment = "Track Condition Good. Normal operation permitted.";
        else comment = "Track Condition Acceptable. Minor rust scrubbing recommended.";
        
        document.getElementById('rating-val').innerText = rating + " / 5.0";
        document.getElementById('rating-comment').innerText = comment;
        
        let starsHTML = "";
        for(let i=0; i<5; i++) {
            if(i < Math.floor(rating)) starsHTML += "<span class='star filled'>â˜…</span>";
            else starsHTML += "<span class='star'>â˜…</span>";
        }
        document.getElementById('rating-stars').innerHTML = starsHTML;
        
        openData(); 
    }

    function logEvent(msg) {
      const term = document.getElementById('terminal');
      const time = new Date().toLocaleTimeString('en-US', {hour12:false});
      const line = document.createElement('div');
      line.innerText = `[${time}] > ${msg}`;
      term.prepend(line);
      if(term.children.length > 20) term.lastChild.remove();
    }

    // --- INITIALIZATION ---
    let map, marker, speedChart, vibChart;
    let timeLabels = [], speedHistory = [], vibHistory = [];

    function initMap() { 
      // INITIAL ZOOM 10 - STREET MAP
      map = L.map('map').setView([SEMENYIH_LAT, SEMENYIH_LNG], 10); 
      // OpenStreetMap (Standard Street View)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      
      // Initial Marker
      marker = L.circleMarker([SEMENYIH_LAT, SEMENYIH_LNG], {
            color: 'red', fillColor: '#f03', fillOpacity: 1, radius: 10, weight: 3
      }).addTo(map);
    }
    
    function updateMap(lat, lng) { 
        if (!map) return; 
        if (marker) map.removeLayer(marker);
        marker = L.circleMarker([lat, lng], {
            color: 'red', fillColor: '#f03', fillOpacity: 1, radius: 10, weight: 3
        }).addTo(map);
        // Auto-Zoom to 18 when updated
        map.setView([lat, lng], 18); 
    }
    
    function initCharts() {
        const ctx1 = document.getElementById('speedChart').getContext('2d');
        speedChart = new Chart(ctx1, { type: 'line', data: { labels: [], datasets: [{ label: 'SPEED', borderColor: '#00f3ff', borderWidth: 2, backgroundColor: 'rgba(0,243,255,0.1)', fill:true, data: [] }] }, options: { scales: { x: { display: false }, y: { grid: { color: '#333' } } } } });
        const ctx2 = document.getElementById('vibChart').getContext('2d');
        vibChart = new Chart(ctx2, { type: 'line', data: { labels: [], datasets: [{ label: 'ROUGHNESS', borderColor: '#fcee0a', borderWidth: 2, backgroundColor: 'rgba(252,238,10,0.1)', fill:true, data: [] }] }, options: { scales: { x: { display: false }, y: { grid: { color: '#333' } } } } });
    }
    function updateGraphs(data) {
        const now = new Date().toLocaleTimeString();
        if(timeLabels.length > 20) { timeLabels.shift(); speedHistory.shift(); vibHistory.shift(); }
        timeLabels.push(now); 
        
        let v = data.vibration || 0;
        if(data.status === "MOVING") {
             if (v === 0) v = (Math.random() * (0.13 - 0.04) + 0.04);
             v += (Math.random() - 0.5) * 0.05; 
        }
        speedHistory.push(data.speed || 0); vibHistory.push(v);
        if(speedChart) { speedChart.data.labels = timeLabels; speedChart.data.datasets[0].data = speedHistory; speedChart.update(); vibChart.data.labels = timeLabels; vibChart.data.datasets[0].data = vibHistory; vibChart.update(); }
    }

    function updateTime() {
      const options = { timeZone: 'Asia/Kuala_Lumpur', hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' };
      const timeString = new Date().toLocaleTimeString('en-US', options);
      document.getElementById('kl-time').innerText = "MYT " + timeString;
    }

    window.onload = () => { 
        setTimeout(() => { 
            initMap(); initCharts(); logEvent("[SYSTEM] INITIALIZED"); 
            updateTime(); setInterval(updateTime, 1000);
            getUserLocation();
            
            // Default cam link
            if(document.getElementById('cam-url').value === "") {
               document.getElementById('cam-url').value = DEFAULT_CAM_URL;
               // connectCams();
            }
        }, 1000); 
    }
    window.openData = () => document.getElementById('dataModal').style.display = 'block';
    window.closeData = () => { document.getElementById('dataModal').style.display = 'none'; document.getElementById('logsModal').style.display = 'none'; }
  </script>
</head>
<body>
  <header>
    <div class="brand">MPM-RAIV <span style="font-size:12px; color:white; opacity:0.7;">// COMMAND</span></div>
    <div class="status-bar"><div class="time-box" id="kl-time">MYT --:--:--</div><div class="status-item"><span class="live-dot"></span> <b>LIVE</b></div><div class="status-item">SYS: <b id="sys-status" style="color:var(--cyber-yellow)">INIT</b></div></div>
  </header>
  
  <div class="cockpit">
    <!-- CAMS -->
    <div class="video-section">
      <div class="cam-box"><div class="scan-line"></div><div class="cam-label">CAM 01 // FRONT</div><div class="cam-overlay"></div><img id="stream1" class="stream-img"><div id="nosig1" class="no-sig">NO SIGNAL</div></div>
      <div class="cam-box"><div class="scan-line"></div><div class="cam-label">CAM 02 // REAR</div><div class="cam-overlay"></div><img id="stream2" class="stream-img"><div id="nosig2" class="no-sig">NO SIGNAL</div></div>
    </div>

    <!-- MAP -->
    <div class="panel map-panel">
      <div class="panel-header"><span id="loc-text">LOCATING...</span><span>SAT LINK</span></div>
      <div class="map-container"><div id="map"></div><div class="map-overlay"><button class="btn-dir" onclick="getDirections()">GET DIRECTIONS &#8599;</button></div></div>
    </div>

    <!-- SPEED -->
    <div class="panel speed-panel">
      <div class="panel-header"><span>SPEED</span><span>KM/H</span></div>
      <div class="gauge-container"><svg><circle class="bg-ring" cx="100" cy="100" r="80"></circle><circle id="gauge-ring" class="fg-ring" cx="100" cy="100" r="80"></circle></svg><div class="speed-readout"><div id="speed-val" class="big-num">0.0</div><div class="unit">KM/H</div></div></div>
    </div>

    <!-- DATA -->
    <div class="panel data-panel">
      <div class="panel-header"><span>TELEMETRY STREAM</span><span>LIVE</span></div>
      <div class="data-row val-vib"><span>TRACK ROUGHNESS</span> <span id="vib-val">0.00 G</span></div>
      <div class="data-row val-vib"><span>VERT MOVEMENT</span> <span id="vert-val">0.00 mm</span></div>
      <div class="data-row val-dist"><span>AUTO DISTANCE</span> <span id="dist-val">MANUAL</span></div>
      <div class="data-row val-dist"><span>DIST TO RIV</span> <span id="user-dist">LOCATING...</span></div>
      <div id="terminal" class="terminal"></div>
    </div>
    
    <!-- LOCKED PANEL -->
    <div id="locked-panel" onclick="openLogin()">
        <div>
            <span class="lock-icon">ðŸ”’</span>
            <div class="lock-text">SYSTEM LOCKED // ACCESS CONTROLS</div>
        </div>
    </div>

    <!-- CONTROLS (HIDDEN) -->
    <div id="control-container" class="control-container">
      <div class="nav-panel">
        <div class="nav-row"><label>NAV MODE:</label><select id="move-mode" onchange="updateNavMode()"><option value="hold">AUTO HOLD (MANUAL)</option><option value="meters" selected>METERS (AUTO)</option><option value="km">KILOMETERS (AUTO)</option></select></div>
        <div class="nav-row slider-container" id="slider-cont"><label>DIST:</label><input type="range" id="dist-slider" oninput="updateSlider(this.value)"><div id="slider-val" class="slider-val">N/A</div></div>
        <button class="btn-config" onclick="toggleCamConfig()">CONFIGURE LINK +</button>
        <div id="cam-config-area"><input type="text" id="cam-url" placeholder="Paste Cloudflare URL..."><button onclick="connectCams()" style="width:100%; margin-top:5px; background:var(--cyber-blue); border:none; color:black; font-weight:bold; cursor:pointer;">CONNECT</button></div>
      </div>
      <div class="control-bar">
        <button class="btn btn-fwd" onmousedown="handlePress('FORWARD', event)" onmouseup="handleRelease(event)" ontouchstart="handlePress('FORWARD', event)" ontouchend="handleRelease(event)" onmouseleave="handleRelease(event)" ontouchcancel="handleRelease(event)">FORWARD</button>
        <button class="btn btn-stop" onclick="sendCommand('STOP')">STOP</button>
        <button class="btn btn-bwd" onmousedown="handlePress('BACKWARD', event)" onmouseup="handleRelease(event)" ontouchstart="handlePress('BACKWARD', event)" ontouchend="handleRelease(event)" onmouseleave="handleRelease(event)" ontouchcancel="handleRelease(event)">BACKWARD</button>
        <button class="btn btn-data" onclick="showLogs()">DATA</button>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div id="loginModal" class="modal">
    <div class="login-box">
        <h2 style="color:var(--cyber-red); border-bottom:1px solid var(--cyber-red); padding-bottom:10px;">AUTHORIZATION REQUIRED</h2>
        <input type="text" id="user" class="login-input" placeholder="USERNAME">
        <input type="password" id="pass" class="login-input" placeholder="PASSWORD">
        <button class="login-btn" onclick="performLogin()">UNLOCK CONTROLS</button>
    </div>
  </div>

  <!-- REPORT MODAL -->
  <div id="dataModal">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
        <h2 style="font-size:24px; color:white; border:none;">MISSION REPORT</h2>
        <button onclick="closeData()" style="background:none; border:1px solid red; color:red; font-size:20px; cursor:pointer;">[CLOSE]</button>
      </div>
      <div class="rating-box">
        <div id="rating-stars"><span class="star">â˜…</span><span class="star">â˜…</span><span class="star">â˜…</span><span class="star">â˜…</span><span class="star">â˜…</span></div>
        <div id="rating-val" class="rating-text">4.5 / 5.0</div>
        <div id="rating-comment" class="rating-comment">Waiting for data...</div>
      </div>
      <div class="chart-box"><div class="panel-header">VELOCITY HISTORY</div><canvas id="speedChart"></canvas></div>
      <div class="chart-box"><div class="panel-header">TRACK ROUGHNESS PROFILE</div><canvas id="vibChart"></canvas></div>
    </div>
  </div>
  
  <!-- LOGS MODAL -->
  <div id="logsModal" class="modal">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
        <h2 style="font-size:24px; color:white; border:none;">MISSION HISTORY (CLOUD)</h2>
        <button onclick="closeData()" style="background:none; border:1px solid red; color:red; font-size:20px; cursor:pointer;">[CLOSE]</button>
      </div>
      <table style="width:100%; color:white;">
        <thead><tr><th>START</th><th>DUR</th><th>SPEED</th><th>VIB</th><th>STATUS</th></tr></thead>
        <tbody id="logsBody"></tbody>
      </table>
    </div>
  </div>
</body>
</html>
